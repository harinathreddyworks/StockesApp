trigger:
  branches:
    include:
      - main

pr:
  branches:
    include:
      - '*'

jobs:
- job: AI_Code_Review
  pool:
    name: 'Default'

  steps:
  - task: UsePythonVersion@0
    inputs:
      versionSpec: '3.10'
      addToPath: true
    displayName: 'Use Python 3.10'

  - script: |
      pip install openai
      python - <<EOF
      import openai, os, glob

      openai.api_key = os.getenv("OPENAI_API_KEY")

      files = glob.glob("**/*.py", recursive=True)
      for fpath in files:
          with open(fpath, "r", encoding="utf-8") as f:
              content = f.read()
              prompt = f"Review this Python code for bugs, performance issues, and best practices:\n\n{content[:6000]}"
              response = openai.ChatCompletion.create(
                  model="gpt-4o-mini",
                  messages=[{"role": "user", "content": prompt}]
              )
              print(f"\nâœ… Review for {fpath}:\n{response.choices[0].message['content']}\n{'-'*80}")
      EOF
    env:
      OPENAI_API_KEY: $(OpenAI_ApiKey)
    displayName: 'Run OpenAI Code Review'
